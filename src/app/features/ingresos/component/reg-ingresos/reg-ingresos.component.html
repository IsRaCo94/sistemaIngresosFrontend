<section class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1>INGRESOS</h1>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-right">
          <li class="breadcrumb-item"><a routerLink="/ingresos/dashboard">Inicio</a></li>
          <li class="breadcrumb-item active">Ingresos</li>
        </ol>
      </div>
    </div>
  </div>
</section>

<section class="content">
  <div class="container-fluid">
    <!-- <div *ngIf="loading">
            <div class="preloader flex-column justify-content-center align-items-center">
                <img src="assets/img/logocbes.jpg" class="animation__wobble" alt="cossmilLogo" height="80"
                    width="80">
            </div>
        </div> -->
    <div class="row" *ngIf="!loading">
      <div class="col-md-12">
        <div class="card card-primary">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal"
                  [routerLink]="['create']" [disabled]="disableNuevoRegistroForToday">
                  <em class="fa fa-plus"></em>&nbsp; Nuevo Registro
                </button>
              </div>
              <!-- <div class="col-md-6 text-right">
                <button type="button" class="btn btn-success" (click)="generateDailyReport()">
                  <em class="fa-solid fa-lock"></em>&nbsp; Informe Diario
                </button>
              </div> -->
            </div>
          </div>
        </div>


        <!-- Document Type Filter Buttons -->
        <div class="card card-info">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-filter"></i> TIPO DE EMISIONES
            </h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-12">
                <div class="btn-group" role="group" aria-label="Document Type Filter">
                  <button 
                    *ngFor="let docType of documentTypes" 
                    type="button" 
                    class="btn"
                    [class]="selectedDocumentType === docType.value ? 'btn-primary' : 'btn-outline-primary'"
                    (click)="onDocumentTypeChange(docType.value)">
                    <i class="fas" [ngClass]="docType.icon"></i>&nbsp; {{docType.label}}
                    <span class="badge badge-light ml-2" *ngIf="docType.value !== 'TODOS'">
                      {{getDocumentCount(docType.value)}}
                    </span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Search Bar -->
        <div class="card card-warning">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-search"></i> Buscar en Registros
            </h3>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text">
                      <i class="fas fa-search"></i>
                    </span>
                  </div>
                  <input 
                    type="text" 
                    class="form-control" 
                    placeholder="Buscar por número de recibo, factura, lugar, proveedor o detalle..."
                    [(ngModel)]="searchTerm"
                    (input)="onSearchChange()">
                  <div class="input-group-append" *ngIf="searchTerm">
                    <button 
                      class="btn btn-outline-secondary" 
                      type="button" 
                      (click)="clearSearch()"
                      title="Limpiar búsqueda">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="text-right">
                  <small class="text-muted">
                    <i class="fas fa-info-circle"></i>
                    Busca en: Número de recibo, factura, lugar, proveedor y detalle
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- FACTURAS Section -->
        <div class="card card-success" *ngIf="selectedDocumentType === 'TODOS' || selectedDocumentType === 'FACTURA'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-file-invoice"></i> FACTURAS
              <span class="badge badge-success ml-2">{{getFacturas().length}} registros</span>
              <span class="badge badge-warning ml-1" *ngIf="searchTerm">
                <i class="fas fa-search"></i> Filtrados
              </span>
            </h3>
          </div>
          <div class="card-body">
            <div class="table-responsive" *ngIf="getFacturas().length > 0; else noFacturas">
              <table class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                  <tr>
                    <th *ngFor="let titulo of titulosColumnas">
                      {{titulo}}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let lista of getFacturas(); let i=index">
                    <td>{{lista.num_recibo}} </td>
                    <td>{{lista.num_factura}} </td>
                    <td>{{lista.lugar}}</td>
                    <td>{{lista.fecha | date:'dd-MM-yyyy':'-0400'}}</td>
                    <td>
                      <span class="badge badge-success">{{lista.tipo_ingres || lista.tipo_emision}}</span>
                    </td>
                    <td>{{lista.proveedor}}</td>
                    <td>{{lista.detalle}}</td>
                    <td>{{ lista.importe_total | number:'1.2-2':'en-US' }}</td>
                    <td>
                      <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-warning btn-sm" style="margin: 2px;"
                          (click)="editarRegistro(lista.id_ingresos)" data-placement="bottom" data-toggle="tooltip"
                          title="Editar">
                          <i class="fa-solid fa-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" style="margin: 2px;"
                          (click)="eliminarRegistro(lista.id_ingresos)" data-placement="bottom" data-toggle="tooltip"
                          title="Borrar">
                          <i class="fa-solid fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <ng-template #noFacturas>
              <div class="alert alert-info text-center" *ngIf="!searchTerm">
                <i class="fas fa-info-circle"></i> No hay registros de FACTURAS
              </div>
              <div class="alert alert-warning text-center" *ngIf="searchTerm">
                <i class="fas fa-search"></i> No se encontraron FACTURAS que coincidan con "{{searchTerm}}"
                <br>
                <button class="btn btn-sm btn-outline-warning mt-2" (click)="clearSearch()">
                  <i class="fas fa-times"></i> Limpiar búsqueda
                </button>
              </div>
            </ng-template>
          </div>
        </div>

        <!-- RECIBOS Section -->
        <div class="card card-info" *ngIf="selectedDocumentType === 'TODOS' || selectedDocumentType === 'RECIBO'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-receipt"></i> RECIBOS
              <span class="badge badge-info ml-2">{{getRecibos().length}} registros</span>
              <span class="badge badge-warning ml-1" *ngIf="searchTerm">
                <i class="fas fa-search"></i> Filtrados
              </span>
            </h3>
          </div>
          <div class="card-body">
            <div class="table-responsive" *ngIf="getRecibos().length > 0; else noRecibos">
              <table class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                  <tr>
                    <th *ngFor="let titulo of titulosColumnas">
                      {{titulo}}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let lista of getRecibos(); let i=index">
                    <td>{{lista.num_recibo}} </td>
                    <td>{{lista.num_factura}} </td>
                    <td>{{lista.lugar}}</td>
                    <td>{{lista.fecha | date:'dd-MM-yyyy':'-0400'}}</td>
                    <td>
                      <span class="badge badge-info">{{lista.tipo_ingres || lista.tipo_emision}}</span>
                    </td>
                    <td>{{lista.proveedor}}</td>
                    <td>{{lista.detalle}}</td>
                    <td>{{ lista.importe_total | number:'1.2-2':'en-US' }}</td>
                    <td>
                      <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-warning btn-sm" style="margin: 2px;"
                          (click)="editarRegistro(lista.id_ingresos)" data-placement="bottom" data-toggle="tooltip"
                          title="Editar">
                          <i class="fa-solid fa-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" style="margin: 2px;"
                          (click)="eliminarRegistro(lista.id_ingresos)" data-placement="bottom" data-toggle="tooltip"
                          title="Borrar">
                          <i class="fa-solid fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <ng-template #noRecibos>
              <div class="alert alert-info text-center" *ngIf="!searchTerm">
                <i class="fas fa-info-circle"></i> No hay registros de RECIBOS
              </div>
              <div class="alert alert-warning text-center" *ngIf="searchTerm">
                <i class="fas fa-search"></i> No se encontraron RECIBOS que coincidan con "{{searchTerm}}"
                <br>
                <button class="btn btn-sm btn-outline-warning mt-2" (click)="clearSearch()">
                  <i class="fas fa-times"></i> Limpiar búsqueda
                </button>
              </div>
            </ng-template>
          </div>
        </div>

        <!-- DOCUMENTOS Section -->
        <div class="card card-warning" *ngIf="selectedDocumentType === 'TODOS' || selectedDocumentType === 'DOCUMENTO'">
          <div class="card-header">
            <h3 class="card-title">
              <i class="fas fa-file-alt"></i> DOCUMENTOS
              <span class="badge badge-warning ml-2">{{getDocumentos().length}} registros</span>
              <span class="badge badge-info ml-1" *ngIf="searchTerm">
                <i class="fas fa-search"></i> Filtrados
              </span>
            </h3>
          </div>
          <div class="card-body">
            <div class="table-responsive" *ngIf="getDocumentos().length > 0; else noDocumentos">
              <table class="table table-bordered table-striped table-hover">
                <thead class="thead-dark">
                  <tr>
                    <th *ngFor="let titulo of titulosColumnas">
                      {{titulo}}
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let lista of getDocumentos(); let i=index">
                    <td>{{lista.num_recibo}} </td>
                    <td>{{lista.num_factura}} </td>
                    <td>{{lista.lugar}}</td>
                    <td>{{lista.fecha | date:'dd-MM-yyyy':'-0400'}}</td>
                    <td>
                      <span class="badge badge-warning">{{lista.tipo_ingres || lista.tipo_emision}}</span>
                    </td>
                    <td>{{lista.proveedor}}</td>
                    <td>{{lista.detalle}}</td>
                    <td>{{ lista.importe_total | number:'1.2-2':'en-US' }}</td>
                    <td>
                      <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-warning btn-sm" style="margin: 2px;"
                          (click)="editarRegistro(lista.id_ingresos)" data-placement="bottom" data-toggle="tooltip"
                          title="Editar">
                          <i class="fa-solid fa-pencil"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" style="margin: 2px;"
                          (click)="eliminarRegistro(lista.id_ingresos)" data-placement="bottom" data-toggle="tooltip"
                          title="Borrar">
                          <i class="fa-solid fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <ng-template #noDocumentos>
              <div class="alert alert-info text-center" *ngIf="!searchTerm">
                <i class="fas fa-info-circle"></i> No hay registros de DOCUMENTOS
              </div>
              <div class="alert alert-warning text-center" *ngIf="searchTerm">
                <i class="fas fa-search"></i> No se encontraron DOCUMENTOS que coincidan con "{{searchTerm}}"
                <br>
                <button class="btn btn-sm btn-outline-warning mt-2" (click)="clearSearch()">
                  <i class="fas fa-times"></i> Limpiar búsqueda
                </button>
              </div>
            </ng-template>
          </div>
        </div>
      </div>
    </div>
  </div>

</section>